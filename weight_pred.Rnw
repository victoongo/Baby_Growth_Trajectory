\documentclass{article}
\usepackage{pdflscape}
\usepackage{graphicx}
\usepackage[margin = 1 cm]{geometry}
\begin{document}

<<data_cleaning, cache = FALSE, include = FALSE, eval = TRUE>>=
library(sitar)
library(ggplot2)
library(plyr)
library(nlme)

setwd("~/Projects/R_lib/bmi/data")
bmi<-read.csv("bmi.csv", as.is=TRUE)
bmi <- unique(bmi)
bmi$id <- bmi$mom_nestid * 100000 + bmi$nestid
bmi <- bmi[bmi$X_bivwt==0,]

waz <- bmi[!is.na(bmi$weight),]
waz <- subset(waz, select=c(weight, agemos, id, ref_date, wt_source, sex, 
                            BMI_LMP_kgm2, mat_gest_wt_gain_category2,
                            gest_weight_gain_kg, GestAge_TotalDays, smoker, maternal_smoking2, parity_3cat, 
                            mom_age_delv, race_final4, education4, GEST_DIABETES, PREGNANCY_HYPERTENSION))
waz <- unique(waz)
minmax <- ddply(waz, .(id), summarize, agemos_min=min(agemos), agemos_max=max(agemos))
minmax_keep <- minmax[minmax$agemos_min<=0.5 & minmax$agemos_max>=17,]
waz <- waz[waz$id %in% minmax_keep$id,]
waz <- waz[waz$agemos<=25,]
# mplot(agemos, weight, id, nwaz)
outliers <- velout(agemos, weight, id, waz, limit=0.5, linearise=TRUE)
nwaz <- zapvelout(outliers, icode=c(4,5,6,8))
# ag <- ddply(outliers, .(id), summarize, weight_mean=mean(weight), weight_sd=sd(weight))
# summary(ag)
# box_stats <- boxplot(ag$weight_sd, na.rm=TRUE, col="blue", plot=FALSE)
# keep_list <- ag[ag$weight_sd<2.5,]
# keep_list <- keep_list[!is.na(keep_list$weight_sd),]
# nwaz <- nwaz[nwaz$id %in% keep_list$id,]
nwaz <- nwaz[!is.na(nwaz$weight),]
waz_freq <- table(nwaz$id)
waz_keep <- data.frame(waz_freq[waz_freq>7])
nwaz <- nwaz[nwaz$id %in% rownames(waz_keep),]

nwaz$weight <- log(nwaz$weight)

nwaz$bmic5.f <- factor(cut(nwaz$BMI_LMP_kgm2, c(0, 18.5, 25, 30, 35, 100), right=F))
contrasts(nwaz$bmic5.f) <- contr.treatment(5, base=2)

nwaz$educ.f <- factor(nwaz$education4)
nwaz$race.f <- factor(nwaz$race_final4)
nwaz$parity.f <- factor(nwaz$parity_3cat)
nwaz$smoker.f <- factor(nwaz$smoker)
nwaz$gest_dbt.f <- factor(nwaz$GEST_DIABETES)
contrasts(nwaz$gest_dbt.f) <- contr.treatment(2, base=2)
nwaz$preg_ht.f <- factor(nwaz$PREGNANCY_HYPERTENSION)
contrasts(nwaz$preg_ht.f) <- contr.treatment(2, base=2)
nwaz$mat_gest_wt_gain_c3.f <- factor(nwaz$mat_gest_wt_gain_category2)
contrasts(nwaz$mat_gest_wt_gain_c3.f) <- contr.treatment(3, base=2)

swaz <- nwaz[nwaz$id<100000000,]
@

<<descriptive_plots, dev = 'pdf', echo = FALSE, include = FALSE, eval = TRUE, out.width='.5\\linewidth', fig.show = 'hold'>>=
qplot(agemos, weight, data=nwaz, geom=c("point","smooth"), method="gam", formula=y~ns(x,3), 
      alpha=I(1/3), colour=factor(sex), main="Scatter Plot with Natural Spline Smoothed Curve") +
  theme(legend.position="none")
qplot(agemos, weight, data=nwaz, geom=c("line"), alpha=I(1/3), colour=factor(id), 
      main="Line Graph for weight") +
  theme(legend.position="none")
ggplot(nwaz, aes(agemos, weight, colour=factor(id))) + 
  geom_smooth(aes(group=id, colour=factor(id)), methos="gam", se=F, alpha=I(1/3), size=0.2) +
  geom_smooth(aes(group=1, colour="red"), method="gam", formula=y~ns(x,3), se=F, size=1) +
  theme(legend.position="none") +
  ggtitle("Smoothed Line Graph for weight")
@

<<hlm, cache = FALSE, echo = FALSE, include = FALSE>>=
cm <- lme(weight ~ agemos + I(agemos^2) + I(agemos^3), data=nwaz, random= ~ agemos | id, method="ML")
pwaz <- nwaz
pwaz$pred_cm <- predict(cm, newdata=pwaz,level=0)

cm_sex <- lme(weight ~ agemos + I(agemos^2) + I(agemos^3) + sex, data=nwaz, random= ~ agemos | id, method="ML")
pwaz <- pwaz
pwaz$pred_cm_sex <- predict(cm, newdata=pwaz,level=0)
@

<<sitar, cache = FALSE, echo = TRUE, include = TRUE>>=

m1 <- sitar(x=agemos, y=weight, id=id, data=nwaz, df=3)

m11a <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, a.formula=~BMI_LMP_kgm2
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)
m11b <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, b.formula=~BMI_LMP_kgm2
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)
m11c <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, c.formula=~BMI_LMP_kgm2
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)

m11 <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, 
              a.formula=~BMI_LMP_kgm2
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              b.formula=~BMI_LMP_kgm2
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              c.formula=~BMI_LMP_kgm2
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)
m111 <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz[nwaz$sex==1,]), df=3, 
              a.formula=~BMI_LMP_kgm2
              +gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              b.formula=~BMI_LMP_kgm2
              +gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              c.formula=~BMI_LMP_kgm2
              +gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)
m112 <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz[nwaz$sex==2,]), df=3, 
              a.formula=~BMI_LMP_kgm2
              +gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              b.formula=~BMI_LMP_kgm2
              +gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              c.formula=~BMI_LMP_kgm2
              +gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)

m11f <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, 
              a.formula=~bmic5.f
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              b.formula=~bmic5.f
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              c.formula=~bmic5.f
              +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)


# m12a <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, a.formula=~BMI_LMP_kgm2
#               +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
#               +gest_dbt.f+preg_ht.f+maternal_smoking2)
# m12b <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, b.formula=~BMI_LMP_kgm2
#               +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
#               +gest_dbt.f+preg_ht.f+maternal_smoking2)
# m12c <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, c.formula=~BMI_LMP_kgm2
#               +sex+gest_weight_gain_kg+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
#               +gest_dbt.f+preg_ht.f+maternal_smoking2)

m21a <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, a.formula=~mat_gest_wt_gain_c3.f
              +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)
m21b <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, b.formula=~mat_gest_wt_gain_c3.f
              +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)
m21c <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, c.formula=~mat_gest_wt_gain_c3.f
              +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)

m21 <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, 
              a.formula=~mat_gest_wt_gain_c3.f
              +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              b.formula=~mat_gest_wt_gain_c3.f
              +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              c.formula=~mat_gest_wt_gain_c3.f
              +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)
m211 <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz[nwaz$sex==1,]), df=3, 
              a.formula=~mat_gest_wt_gain_c3.f
              +GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              b.formula=~mat_gest_wt_gain_c3.f
              +GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              c.formula=~mat_gest_wt_gain_c3.f
              +GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)
m212 <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz[nwaz$sex==2,]), df=3, 
              a.formula=~mat_gest_wt_gain_c3.f
              +GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              b.formula=~mat_gest_wt_gain_c3.f
              +GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f, 
              c.formula=~mat_gest_wt_gain_c3.f
              +GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
              +gest_dbt.f+preg_ht.f+smoker.f)

# m22a <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, a.formula=~mat_gest_wt_gain_c3.f
#               +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
#               +gest_dbt.f+preg_ht.f+maternal_smoking2)
# m22b <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, b.formula=~mat_gest_wt_gain_c3.f
#               +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
#               +gest_dbt.f+preg_ht.f+maternal_smoking2)
# m22c <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, c.formula=~mat_gest_wt_gain_c3.f
#               +sex+GestAge_TotalDays+parity.f+mom_age_delv+race.f+educ.f
#               +gest_dbt.f+preg_ht.f+maternal_smoking2)

m11f.coef <- data.frame(summary(m11f)$tTable)
save(m11f.coef, file="m11.Rda")
m21.coef <- summary(m11f)$tTable
save(m21.coef, file="m21.Rda")

rm(m21.coef)

m11f.coef$rn <- row.names(m11f.coef)
# unlist(strsplit(as.character(m11f.coef$rn), split=".", fixed=T))
# strsplit(as.character(m11f.coef$rn), split=".", fixed=T)
varnames <- colsplit(as.character(m11f.coef$rn), "\\.", c("fe","cov"))
m11fa.coef <- data.frame(m11f.coef, varnames)
m11fa.coef <- subset(m11fa.coef, select=c("fe", "cov", "Value", "p.value"))
m11fa.coef <- m11fa.coef[!(m11fa.coef$fe %in% c("s1", "s2", "s3")),]
m11fa.coef <- m11fa.coef[!(m11fa.coef$cov==""),]
rownames(m11fa.coef) <- c(1:length(m11fa.coef$fe))
# melt(m11fa.coef, id=c("fe", "cov"))
m11fa <- reshape(data=m11fa.coef, timevar="fe", idvar="cov", direction="wide")
write.table(m11fa, file = "m11fa.csv", sep = ",", col.names = NA, qmethod = "double")

out.sitar <- function(tmp.mf) {
  tmp.mf.coef <- data.frame(summary(tmp.mf)$tTable)
  tmp.mf.coef$rn <- row.names(tmp.mf.coef)
  varnames <- colsplit(as.character(tmp.mf.coef$rn), "\\.", c("fe","cov"))
  tmp.mfa.coef <- data.frame(tmp.mf.coef, varnames)
  tmp.mfa.coef <- subset(tmp.mfa.coef, select=c("fe", "cov", "Value", "p.value"))
  tmp.mfa.coef <- tmp.mfa.coef[!(tmp.mfa.coef$fe %in% c("s1", "s2", "s3")),]
  tmp.mfa.coef <- tmp.mfa.coef[!(tmp.mfa.coef$cov==""),]
  rownames(tmp.mfa.coef) <- c(1:length(tmp.mfa.coef$fe))
  tmp.mfa <- reshape(data=tmp.mfa.coef, timevar="fe", idvar="cov", direction="wide")
  write.table(tmp.mfa, file="out.csv", sep = ",", col.names = NA, qmethod = "double")
}
out.sitar(m11f)
out.sitar(m21)

m11a.coef <- summary(m11a)$tTable
m11b.coef <- summary(m11b)$tTable
m11c.coef <- summary(m11c)$tTable

m12a.coef <- summary(m12a)$tTable
m12b.coef <- summary(m12b)$tTable
m12c.coef <- summary(m12c)$tTable

m21a.coef <- summary(m21a)$tTable
m21b.coef <- summary(m21b)$tTable
m21c.coef <- summary(m21c)$tTable

m22a.coef <- summary(m22a)$tTable
m22b.coef <- summary(m22b)$tTable
m22c.coef <- summary(m22c)$tTable

# all.coef <- Reduce(function(x,y) merge(x,y,by="row.names",all=T), list(m11a.coef, m21a.coef, m12a.coef))
# all.coef <- merge(m11a.coef, m21a.coef, by="row.names", all=TRUE)
# str(all.coef)
# all.coef <- merge(all.coef, m12a.coef, by="row.names", all=TRUE)
# str(m11a.coef)

l <- list(m11a.coef, m11b.coef, m11c.coef, m12a.coef, m12b.coef, m12c.coef, 
          m21a.coef, m21b.coef, m21c.coef, m22a.coef, m22b.coef, m22c.coef)
for(i in 1:length(l)) {
  l[[i]]$rn <- row.names(l[[i]])
}
all.coef <- l[[1]]
for(i in 2:length(l)) {
  all.coef <- merge(all.coef, l[[i]], by="rn", all=TRUE)
}
all.coef[order(all.coef$rn),]

# l <- list(m11a, m11b, m11c, m12a, m12b, m12c)
# l <- list(m21a, m21b, m21c, m22a, m22b, m22c)
l <- list(m11a, m11b, m11c, m21a, m21b, m21c)
l <- list(m21a, m21b, m21c)
for(i in 1:length(l)) {
#   print(l[[i]])
   print(summary(l[[i]]))
}


library(knitr)
knit2pdf('../summary.Rnw')

# all.coef <- join_all(list(m11a.coef, m21a.coef, m12a.coef), "row.names", type='full')

# m11abc <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, 
# a.formula=~sex+BMI_LMP_kgm2+gest_weight_gain_kg, 
#               b.formula=~sex+BMI_LMP_kgm2+gest_weight_gain_kg, c.formula=~sex+BMI_LMP_kgm2+gest_weight_gain_kg)
# m12abc <- sitar(x=agemos, y=weight, id=id, data=na.omit(nwaz), df=3, a.formula=~sex+mat_gest_wt_gain_category2, 
#               b.formula=~sex+mat_gest_wt_gain_category2, c.formula=~sex+mat_gest_wt_gain_category2)

# m11$groups
# m11$fixDF
# m11$varFix
# m11$plist
# head(m11$fitted)
# str(m11$fitted)
# m11$coefficients$random

# nwaz_bmi_p <- unique(subset(nwaz, select=c(id,sex)))
# random_coef <- cbind(nwaz_sex,m1$coefficient$random)
# str(random_coef)
# lm <-lm(random_coef$id.b~random_coef$sex)
# summary(m1)
@

<<plots, dev = 'pdf', echo = FALSE, include = FALSE, eval = TRUE, out.width='.5\\linewidth', fig.show = 'hold'>>=
ggplot(pwaz,aes(x=agemos,y=weight,color=factor(id)),alpha=I(1/3),size=0.5) + 
  geom_line() +
  geom_line(data=pwaz,aes(x=agemos,y=pred_cm),color="black") +
  scale_y_continuous("weight")+
  theme(legend.position="none") +
  ggtitle("Cubic NLME with Random Slope")

ggplot(pwaz,aes(x=agemos,y=weight,color=factor(id)), alpha=I(1/3),size=0.5) + 
  geom_line() +
  geom_line(data=pwaz,aes(x=agemos,y=pred_cm_sex,group=sex), colour="black") +
  scale_y_continuous("weight") +
  theme(legend.position="none") +
  ggtitle("Cubic NLME with Random Slope Controlling for Sex")

plot(m1, y2par=list(col='blue'), apv=TRUE)
plot(m1, opt='a', col=1+as.integer(id) %% 5, xlim=xaxsd())
lines(m1, opt='d', col='red', lwd=2)

plot(m11a, y2par=list(col='blue'), apv=TRUE)
plot(m11a, opt='a', col=1+as.integer(id) %% 5, xlim=xaxsd())
lines(m11a, opt='d', col='red', lwd=2)
@

\end{document}